var e=Object.defineProperty,t=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,l=(t,i,a)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[i]=a,n=(e,n)=>{for(var s in n||(n={}))i.call(n,s)&&l(e,s,n[s]);if(t)for(var s of t(n))a.call(n,s)&&l(e,s,n[s]);return e};import{g as s}from"./jobs.7d18072c.js";import{g as d,p as o,a as h,d as r,e as c,b as p}from"./machines.4eb7d7c2.js";import{p as u}from"./publish.4000da6e.js";import{p as g,j as b,r as m,o as f,c as y,a as C,q as S,w as _,F as I,n as V,l as w,t as z,k as M}from"./vendor.02dbbba7.js";import"./request.d1dca4b5.js";import"./index.a2263c8a.js";const j={name:"Manager",components:{},data:()=>({machines:[],jobs:[],jobsMap:{},selectTypeValue:{},search:"",pageSize:15,pageTotal:0,currentPage:1,selectOption:"1",searchContent:"",dialogVisible:!1,deleteVisible:{},enterBtnTitle:"创建",selectTableChanged:{},addMechineInfo:{ipAddr:"",jobId:[]},groupNameList:{},addAndContinueDisabled:!1,dialogTitle:"新增IP地址",rules:{ipAddr:[{required:!0,message:"请输入正确的IP地址",validator:function(e,t,i){if(""===t||void 0===t||null==t)i(new Error("请输入正确的IP地址"));else{/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/.test(t)||""===t?i():i(new Error("请输入正确的IP地址"))}},trigger:"blur"}]},multipleSelection:[],pageshow:!1,pushing:!1,editObj:null,ipStatusData:[],dialogIpStatusVisible:!1,currentIPStatus:"",ipStatusList:{},needWarning:{}}),created(){},mounted(){this.$route.params.currentPage&&(this.currentPage=parseInt(this.$route.params.currentPage)),this.$route.params.pageSize&&(this.pageSize=parseInt(this.$route.params.pageSize)),this.doGetMechines()},methods:{doAdd(){this.enterBtnTitle="创建",this.dialogTitle="新增IP地址",this.dialogVisible=!0,this.addAndContinueDisabled=!1,this.addMechineInfo={}},doGetMechines(e){s().then((t=>{this.jobs=t.data,t.data.forEach((e=>{this.jobsMap[e.id]=e.name})),e||(e={pageNo:this.currentPage,pageSize:this.pageSize,search:this.searchContent,option:this.selectOption}),d(e).then((e=>{this.machines=e.data.data,this.pageTotal=e.data.totalCount,this.currentPage=e.data.pageNo,this.pageSize=e.data.pageSize,this.pageshow=!1,this.$nextTick((()=>{this.pageshow=!0})),this.deleteVisible={};let t={},i=0;e.data.data.forEach((e=>{this.selectTypeValue[e.id]=e.jobs_id,this.deleteVisible[i]=!1,t[e.ipaddr]=!1;-1!==e.msrv_status.findIndex(((e,t)=>"up"!==e.health))&&(t[e.ipaddr]=!0),i+=1})),this.needWarning=t})).catch((e=>{console.log(e)}))})).catch((e=>{console.log(e)}))},displayIPStatusDialog(e){this.ipStatusData=e.msrv_status,this.currentIPStatus=e.ipaddr,this.dialogIpStatusVisible=!0},cellMouseEnter(e,t,i,a){if("状态"!==t.label&&"status"!==t.label)return;let l={};e.msrv_status.forEach((e=>{void 0!==l[e.health]?l[e.health]+=1:l[e.health]=1})),this.ipStatusList=l},handleSelect(e,t,i){if(e)this.selectTableChanged[i.id]=!1;else if(!1!==this.selectTableChanged[i.id]){var a={};a.id=i.id,a.ipaddr=i.ipaddr,a.jobs_id=this.selectTypeValue[i.id],o(a).then((e=>{this.$notify({title:"成功",message:"更新成功！",type:"success"}),this.selectTableChanged[i.id]=!1,this.selectTypeValue=n({},this.selectTypeValue),this.expandChange(i,i)})).catch((e=>{console.log(e)}))}},tableSelectChange(e,t,i){this.selectTableChanged[i.id]=!0},handleSizeChange(e){let t={pageNo:this.currentPage,pageSize:e,search:this.searchContent,option:this.selectOption};this.doGetMechines(t)},handleCurrentChange(e){let t={pageNo:e,pageSize:this.pageSize,search:this.searchContent,option:this.selectOption};this.doGetMechines(t)},handleClose(e){this.dialogVisible=!1},onSubmitAndContinue(e){this.$refs[e].validate((e=>{if(!e)return!1;{let e={};e.ipaddr=this.addMechineInfo.ipAddr,e.jobs_id=this.addMechineInfo.jobId,h(e).then((e=>{this.$notify({title:"成功",message:"创建成功！",type:"success"}),this.doGetMechines()})).catch((e=>{console.log(e)}))}}))},onSubmit(e){this.$refs[e].validate((t=>{if(!t)return!1;{let t={};t.ipaddr=this.addMechineInfo.ipAddr,t.jobs_id=this.addMechineInfo.jobId,"创建"===this.enterBtnTitle?h(t).then((t=>{this.$notify({title:"成功",message:"创建成功！",type:"success"}),this.doGetMechines(),this.dialogVisible=!1,this.$refs[e].resetFields()})).catch((e=>console.log(e))):(t.id=this.addMechineInfo.id,o(t).then((t=>{this.$notify({title:"成功",message:"更新成功！",type:"success"}),this.selectTypeValue[this.addMechineInfo.id]=this.addMechineInfo.jobId,this.selectTypeValue=n({},this.selectTypeValue),this.dialogVisible=!1,this.editObj.row.jobs_id=this.addMechineInfo.jobId,this.editObj.row.ipaddr=this.addMechineInfo.ipAddr,this.$refs[e].resetFields(),this.expandChange({id:this.addMechineInfo.id},{id:this.addMechineInfo.id})})).catch((e=>console.log(e))))}}))},onCancel(e){this.dialogVisible=!1,this.$refs[e].resetFields()},onSearch(){this.doGetMechines()},onPublish(){this.pushing=!0,u().then((e=>{this.$notify({title:"成功",message:"发布成功！",type:"success"}),this.pushing=!1})).catch((e=>{console.log(e),this.pushing=!1}))},parseTimeSelf(e){var t=new Date(Date.parse(e));return t.toLocaleDateString()+" "+t.toTimeString().split(" ")[0]},doYes(e){r(e.row.id).then((e=>{this.$notify({title:"成功",message:"删除成功！",type:"success"}),this.doGetMechines()})).catch((e=>{console.log(e)})),this.deleteVisible[e.$index]=!1},doNo(e){this.deleteVisible[e.$index]=!1},doDelete(e){this.deleteVisible[e.$index]=!0},rowStyle:e=>({padding:"0"}),cellStyle:e=>({padding:"0"}),edit(e){this.editObj=e,this.enterBtnTitle="更新",this.dialogTitle="编辑IP地址",this.addAndContinueDisabled=!0,this.dialogVisible=!0,this.addMechineInfo={ipAddr:e.row.ipaddr,id:e.row.id},0!==this.selectTypeValue[e.row.id].length?this.addMechineInfo.jobId=this.selectTypeValue[e.row.id]:this.addMechineInfo.jobId=e.row.jobs_id},expandChange(e,t){if(!t||0===t.length)return;let i=[];this.selectTypeValue[e.id].forEach((e=>{i.push(this.jobsMap[e])})),this.groupNameList[e.id]=i},invocate(e){const t=!this.machines[e.$index].enabled,i={id:e.row.id,enabled:t};c(i).then((i=>{this.$notify({title:"成功",message:"更新状态成功！",type:"success"}),this.machines[e.$index].enabled=t,this.machines=[...this.machines]})).catch((e=>console.log(e)))},doBatchAdd(){const e={currentPage:this.currentPage,pageSize:this.pageSize};this.$router.push({name:"BatchOpt",params:e})},doBatchDel(){if(0===this.multipleSelection.length)return this.$notify({title:"警告",message:"未选中任何项！",type:"warning"}),!1;this.$confirm("是否确定删除？","确认信息",{distinguishCancelAndClose:!0,confirmButtonText:"确定",cancelButtonText:"放弃"}).then((e=>{p(this.multipleSelection).then((e=>{this.$notify({title:"成功",message:"删除所选项成功！",type:"success"}),this.doGetMechines()})).catch((e=>console.log(e)))})).catch((e=>console.log(e)))},handleSelectionChange(e){this.multipleSelection=[],e.forEach((e=>{this.multipleSelection.push(e.id)}))}}},k=M();g("data-v-d3b6255a");const x={class:"ipManager-board"},v={class:"action-btn-area"},T={class:"action-btn-del"},P=w("删除选中项"),$={class:"do_action"},A={style:{"padding-right":"15px"}},D=w("发布【file_sd_configs】"),O=w("发布【file_sd_configs】"),E=w("批量添加"),B=w("添加IP"),N=C("span",{type:"warning"},[w("状态 "),C("i",{style:{"font-size":"13px",color:"#0081ff"},class:"el-icon-warning"})],-1),G={class:"pure-table"},U={class:"pure-table-td"},L={class:"pure-table-td"},F=w("查看状态详情"),q=w("查看状态详情"),W=w("编辑"),K=w("禁用"),Y=w("启用"),H=C("p",null,"确定删除吗？",-1),J={style:{"text-align":"right",margin:"0"}},Q=w("取消"),R=w("确定"),X=w("删除"),Z={key:0,class:"block"},ee=w("创建并继续"),te=w("取消"),ie={class:"dialog-ip-status"};b();const ae=k(((e,t,i,a,l,n)=>{const s=m("el-button"),d=m("el-option"),o=m("el-select"),h=m("el-input"),r=m("el-table-column"),c=m("el-descriptions-item"),p=m("el-descriptions"),u=m("el-tooltip"),g=m("el-popover"),b=m("el-table"),M=m("el-pagination"),j=m("el-form-item"),ae=m("el-form"),le=m("el-dialog"),ne=m("el-tag");return f(),y("div",x,[C("div",v,[C("div",T,[C(s,{icon:"el-icon-lightning",size:"small",type:"info",plain:"",onClick:t[1]||(t[1]=e=>n.doBatchDel())},{default:k((()=>[P])),_:1})]),C("div",$,[C("div",A,[!1===l.pushing?(f(),y(s,{key:0,size:"small",icon:"el-icon-upload",type:"primary",onClick:t[2]||(t[2]=e=>n.onPublish())},{default:k((()=>[D])),_:1})):S("",!0),!0===l.pushing?(f(),y(s,{key:1,size:"small",icon:"el-icon-loading",type:"primary"},{default:k((()=>[O])),_:1})):S("",!0),C(s,{size:"small",type:"warning",plain:"",onClick:t[3]||(t[3]=e=>n.doBatchAdd())},{default:k((()=>[E])),_:1}),C(s,{size:"small",type:"success",plain:"",onClick:t[4]||(t[4]=e=>n.doAdd())},{default:k((()=>[B])),_:1})]),C("div",null,[C(h,{size:"small",onKeyup:t[7]||(t[7]=_((e=>n.onSearch()),["enter"])),placeholder:"请输入内容",modelValue:l.searchContent,"onUpdate:modelValue":t[8]||(t[8]=e=>l.searchContent=e),class:"input-with-select"},{prepend:k((()=>[C(o,{class:"searchSelect",modelValue:l.selectOption,"onUpdate:modelValue":t[5]||(t[5]=e=>l.selectOption=e),placeholder:"请选择"},{default:k((()=>[C(d,{label:"IP地址",value:"1"}),C(d,{label:"分组",value:"2"})])),_:1},8,["modelValue"])])),append:k((()=>[C(s,{icon:"el-icon-search",onClick:t[6]||(t[6]=e=>n.onSearch())})])),_:1},8,["modelValue"])])])]),C(b,{size:"mini","highlight-current-row":"",border:"",data:l.machines,stripe:"","row-style":n.rowStyle,"cell-style":n.cellStyle,"header-align":"center",onExpandChange:n.expandChange,onSelectionChange:n.handleSelectionChange,onCellMouseEnter:n.cellMouseEnter},{default:k((()=>[C(r,{type:"selection",width:"40"}),C(r,{type:"expand"},{default:k((e=>[C(p,{title:"分组列表",size:"mini",column:4,border:""},{default:k((()=>[(f(!0),y(I,null,V(l.groupNameList[e.row.id],((e,t)=>(f(),y(c,{key:t,label:t+1},{default:k((()=>[w(z(e),1)])),_:2},1032,["label"])))),128))])),_:2},1024)])),_:1}),C(r,{label:"序号",width:"50px",align:"center","header-align":"center"},{default:k((e=>[w(z(e.$index+1),1)])),_:1}),C(r,{label:"IP地址",prop:"ipaddr",align:"center","header-align":"center"}),C(r,{label:"分组选项",prop:"jobs_id",align:"center","header-align":"center",width:"230px"},{default:k((e=>[C(o,{modelValue:l.selectTypeValue[e.row.id],"onUpdate:modelValue":t=>l.selectTypeValue[e.row.id]=t,class:"borderNone","popper-class":"pppselect",onChange:t=>n.tableSelectChange(t,e.$index,e.row),onVisibleChange:t=>n.handleSelect(t,e.$index,e.row),size:"small",multiple:"","collapse-tags":"",placeholder:"请选择"},{default:k((()=>[(f(!0),y(I,null,V(l.jobs,(e=>(f(),y(d,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","onChange","onVisibleChange"])])),_:1}),C(r,{label:"状态",width:"150px",align:"center","header-align":"center"},{header:k((()=>[C(u,{content:"所有机器状态5分钟更新一次",placement:"top"},{default:k((()=>[N])),_:1})])),default:k((({row:e})=>[C(u,{placement:"left",effect:"light"},{content:k((()=>[C("table",G,[C("tbody",null,[(f(!0),y(I,null,V(l.ipStatusList,((e,t,i)=>(f(),y("tr",{class:"pure-table-tr",key:i},[C("td",U,z(t),1),C("td",L,z(e),1)])))),128))])])])),default:k((()=>[!0===l.needWarning[e.ipaddr]?(f(),y(s,{key:0,class:"el-button-color",icon:"el-icon-warning",type:"text",size:"mini",onClick:t=>n.displayIPStatusDialog(e)},{default:k((()=>[F])),_:2},1032,["onClick"])):(f(),y(s,{key:1,type:"text",size:"mini",icon:"el-icon-sunny",onClick:t=>n.displayIPStatusDialog(e)},{default:k((()=>[q])),_:2},1032,["onClick"]))])),_:2},1024)])),_:1}),C(r,{label:"最后更新账号",prop:"update_by",align:"center","header-align":"center"}),C(r,{label:"最后更新时间",prop:"update_at",align:"center","header-align":"center"},{default:k((({row:e})=>[C("span",null,z(n.parseTimeSelf(e.update_at)),1)])),_:1}),C(r,{label:"操作",align:"center","header-align":"center",width:"210px"},{default:k((e=>[C(s,{type:"primary",plain:"",size:"mini",onClick:t=>n.edit(e)},{default:k((()=>[W])),_:2},1032,["onClick"]),!0===e.row.enabled?(f(),y(s,{key:0,type:"info",plain:"",size:"mini",onClick:t=>n.invocate(e)},{default:k((()=>[K])),_:2},1032,["onClick"])):S("",!0),!1===e.row.enabled?(f(),y(s,{key:1,type:"warning",plain:"",size:"mini",onClick:t=>n.invocate(e)},{default:k((()=>[Y])),_:2},1032,["onClick"])):S("",!0),C(g,{visible:l.deleteVisible[e.$index],placement:"top",width:160},{reference:k((()=>[C(s,{size:"mini",type:"danger",plain:"",onClick:t=>n.doDelete(e)},{default:k((()=>[X])),_:2},1032,["onClick"])])),default:k((()=>[H,C("div",J,[C(s,{size:"mini",type:"text",onClick:t=>n.doNo(e)},{default:k((()=>[Q])),_:2},1032,["onClick"]),C(s,{type:"primary",size:"mini",onClick:t=>n.doYes(e)},{default:k((()=>[R])),_:2},1032,["onClick"])])])),_:2},1032,["visible"])])),_:1})])),_:1},8,["data","row-style","cell-style","onExpandChange","onSelectionChange","onCellMouseEnter"]),l.pageshow?(f(),y("div",Z,[C(M,{onSizeChange:n.handleSizeChange,onCurrentChange:n.handleCurrentChange,"current-page":l.currentPage,"page-sizes":[15,50,100,200],"page-size":l.pageSize,layout:"total, sizes, prev, pager, next, jumper",total:l.pageTotal,ref:"pagination"},null,8,["onSizeChange","onCurrentChange","current-page","page-size","total"])])):S("",!0),C(le,{title:l.dialogTitle,modelValue:l.dialogVisible,"onUpdate:modelValue":t[15]||(t[15]=e=>l.dialogVisible=e),width:"400px",modal:"","before-close":n.handleClose},{default:k((()=>[C("span",null,[C(ae,{"label-position":"right",rules:l.rules,ref:"addMechineInfo",model:l.addMechineInfo,"label-width":"90px",size:"small"},{default:k((()=>[C(j,{label:"IP地址：",prop:"ipAddr"},{default:k((()=>[C(h,{style:{width:"230px"},modelValue:l.addMechineInfo.ipAddr,"onUpdate:modelValue":t[9]||(t[9]=e=>l.addMechineInfo.ipAddr=e),onKeyup:t[10]||(t[10]=_((e=>n.onSubmitAndContinue("addMechineInfo")),["enter"]))},null,8,["modelValue"])])),_:1}),C(j,{label:"分组名：",prop:"jobId"},{default:k((()=>[C(o,{style:{width:"230px"},modelValue:l.addMechineInfo.jobId,"onUpdate:modelValue":t[11]||(t[11]=e=>l.addMechineInfo.jobId=e),placeholder:"请选择","collapse-tags":"",multiple:""},{default:k((()=>[(f(!0),y(I,null,V(l.jobs,((e,t)=>(f(),y(d,{key:t,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),C(j,{size:"small"},{default:k((()=>[C(s,{size:"small",type:"primary",disabled:l.addAndContinueDisabled,onClick:t[12]||(t[12]=e=>n.onSubmitAndContinue("addMechineInfo"))},{default:k((()=>[ee])),_:1},8,["disabled"]),C(s,{size:"small",type:"primary",onClick:t[13]||(t[13]=e=>n.onSubmit("addMechineInfo"))},{default:k((()=>[w(z(l.enterBtnTitle),1)])),_:1}),C(s,{size:"small",type:"info",onClick:t[14]||(t[14]=e=>n.onCancel("addMechineInfo"))},{default:k((()=>[te])),_:1})])),_:1})])),_:1},8,["rules","model"])])])),_:1},8,["title","modelValue","before-close"]),C("div",ie,[C(le,{title:"IP状态信息："+l.currentIPStatus,modelValue:l.dialogIpStatusVisible,"onUpdate:modelValue":t[16]||(t[16]=e=>l.dialogIpStatusVisible=e),width:"900px"},{default:k((()=>[C(b,{data:l.ipStatusData,size:"mini"},{default:k((()=>[C(r,{width:"200px",property:"job",label:"分组"}),C(r,{width:"100px",label:"状态"},{default:k((({row:e})=>["up"===e.health?(f(),y(ne,{key:0,size:"mini",type:"success"},{default:k((()=>[w(z(e.health),1)])),_:2},1024)):"down"===e.health?(f(),y(ne,{key:1,size:"mini",type:"danger"},{default:k((()=>[w(z(e.health),1)])),_:2},1024)):(f(),y(ne,{key:2,type:"info",size:"mini"},{default:k((()=>[w(z(e.health),1)])),_:2},1024))])),_:1}),C(r,{property:"last_error",label:"错误信息"})])),_:1},8,["data"])])),_:1},8,["title","modelValue"])])])}));j.render=ae,j.__scopeId="data-v-d3b6255a";export default j;
