var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,s=(t,i,l)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:l}):t[i]=l;import{a as n,b as d,p as r,c as p,d as h,s as c,e as u,u as b,f as g}from"./jobs.80c7b41c.js";import{c as m}from"./machines.699a4ec2.js";import{r as f}from"./srv.9015609f.js";import{g as y}from"./labelsJob.df5c6042.js";import{p as w,j as _,r as C,o as I,c as P,a as J,q as z,w as V,F as k,n as v,l as x,t as S,k as j}from"./vendor.684f159e.js";import"./request.1a2df1f9.js";import"./index.9c7e7f6b.js";const $={name:"Jobs",data:()=>({jobs:[],addJobInfo:{name:"",port:0,display_order:1,relabel_id:0},relabelList:[],pageSize:15,pageTotal:0,currentPage:1,searchContent:"",deleteVisible:{},dialogVisible:!1,buttonTitle:"",dialogTitle:"",jobAllIPList:{},currentIPValue:[],allIPData:[],allIPDataMap:{},currentJobId:0,editIPVisible:!1,transferChanged:!1,editIPDialog:"未设置",publishMode:!1,pageshow:!0,rules:{name:[{required:!0,message:"请输入正确的分组名称",validator:function(e,t,i){if(""===t||void 0===t||null==t)i(new Error("请输入正确名称"));else{/\s+/.test(t)?i(new Error("名称中不允许有空字符")):i()}},trigger:["blur"]}],port:[{required:!0,type:"number",min:0,max:65535,message:"请输入端口号[>=0, <=65535]",trigger:["change"]}],relabel_id:[{required:!0,type:"number",min:1,message:"请选择重写标签",trigger:["change"]}]}}),created(){},mounted(){this.$route.params.currentPage&&(this.currentPage=parseInt(this.$route.params.currentPage)),this.$route.params.pageSize&&(this.pageSize=parseInt(this.$route.params.pageSize)),this.doGetJobs()},methods:{doAdd(){n().then((e=>{this.relabelList=e.data,this.addJobInfo={name:"",port:0,display_order:1},this.buttonTitle="创建",this.dialogTitle="增加IP分组",this.dialogVisible=!0})).catch((e=>{console.log(e)}))},doEditLabelsJob(e){const n=(d=((e,t)=>{for(var i in t||(t={}))a.call(t,i)&&s(e,i,t[i]);if(l)for(var i of l(t))o.call(t,i)&&s(e,i,t[i]);return e})({},e.row),r={currentPage:this.currentPage,pageSize:this.pageSize},t(d,i(r)));var d,r;this.$router.push({name:"labelsJobs",params:n})},doGetJobs(e){e||(e={pageNo:this.currentPage,pageSize:this.pageSize,search:this.searchContent}),d(e).then((e=>{let t=0;e.data.data.forEach((e=>{this.deleteVisible[t]=!1,t+=1})),this.jobs=e.data.data,this.pageTotal=e.data.totalCount,this.currentPage=e.data.pageNo,this.pageSize=e.data.pageSize,this.pageshow=!1,this.$nextTick((function(){this.pageshow=!0}))})).catch((e=>{console.log(e)}))},doEdit(e){n().then((t=>{this.relabelList=t.data,this.buttonTitle="更新",this.dialogTitle="编辑IP分组",this.addJobInfo.id=e.row.id,this.addJobInfo.name=e.row.name,this.addJobInfo.port=e.row.port,this.addJobInfo.relabel_id=e.row.relabel_id,this.addJobInfo.relabel_name=e.row.relabel_name,this.dialogVisible=!0})).catch((e=>{console.log(e)}))},handleSizeChange(e){let t={pageNo:this.currentPage,pageSize:e,search:this.searchContent};this.doGetJobs(t)},handleCurrentChange(e){let t={pageNo:e,pageSize:this.pageSize,search:this.searchContent};this.doGetJobs(t)},handleClose(e){this.dialogVisible=!1},onSubmit(e){this.$refs[e].validate((t=>{if(!t)return!1;{let t={};t.name=this.addJobInfo.name,t.port=this.addJobInfo.port,t.display_order=this.addJobInfo.display_order,t.relabel_id=this.addJobInfo.relabel_id,"创建"===this.buttonTitle?r(t).then((t=>{this.$notify({title:"成功",message:"创建成功！",type:"success"}),this.doGetJobs(),this.dialogVisible=!1,this.$refs[e].resetFields()})).catch((e=>{console.log(e)})):(t.id=this.addJobInfo.id,p(t).then((t=>{this.$notify({title:"成功",message:"更新成功！",type:"success"}),this.doGetJobs(),this.dialogVisible=!1,this.$refs[e].resetFields()})).catch((e=>{console.log(e)})))}}))},onCancel(e){this.dialogVisible=!1,this.$refs[e].resetFields()},onSearch(){this.doGetJobs()},parseTimeSelf(e){var t=new Date(Date.parse(e));return t.toLocaleDateString()+" "+t.toTimeString().split(" ")[0]},doYes(e){h(e.row.id).then((e=>{this.$notify({title:"成功",message:"删除成功！",type:"success"}),this.doGetJobs()})).catch((e=>{console.log(e)})),this.deleteVisible[e.$index]=!1},doNo(e){this.deleteVisible[e.$index]=!1},doDelete(e){this.deleteVisible[e.$index]=!0},rowStyle:e=>({padding:"0"}),cellStyle:e=>({padding:"0"}),doUp(e){return 0===this.jobs.length?(this.$notify({title:"错误",message:"没有有效的数据！",type:"error"}),!1):1===e.row.display_order?(this.$notify({title:"警告",message:"已经是顶层！",type:"warning"}),!1):void this.swapAction({id:e.row.id,action:"up",display_order:e.row.display_order})},doDown(e){if(0===this.jobs.length)return this.$notify({title:"错误",message:"没有有效的数据！",type:"error"}),!1;return this.jobs[this.jobs.length-1].id===e.row.id&&this.jobs.length!==this.pageSize||this.currentPage*this.pageSize===this.pageTotal?(this.$notify({title:"警告",message:"已经是底层！",type:"warning"}),!1):void this.swapAction({id:e.row.id,action:"down",display_order:e.row.display_order})},swapAction(e){c(e).then((t=>{"up"===e.action?this.$notify({title:"成功",message:"提升成功！",type:"success"}):this.$notify({title:"成功",message:"下降成功！",type:"success"}),this.doGetJobs()})).catch((e=>{console.log(e)}))},publishJobsRunning(){this.$notify({title:"警告",message:"正在发布，请稍等...",type:"warning"})},publishJobsfunc(){this.publishMode=!0,u().then((e=>{this.$notify({title:"成功",message:"发布成功！",type:"success"}),this.publishMode=!1,this.doGetJobs()})).catch((e=>{console.log(e),this.publishMode=!1}))},restartServer(){f().then((e=>{this.$notify({title:"成功",message:"重新加载成功！",type:"success"})})).catch((e=>{console.log(e)}))},expandChange(e,t){t&&0!==t.length&&(this.jobAllIPList[e.id]||y(e.id).then((t=>{this.jobAllIPList[e.id]=t.data})).catch((e=>console.log(e))))},filterIPMethod:(e,t)=>t.spell.indexOf(e)>-1,clearIPClose(e){this.transferChanged&&this.doGetJobs(),this.editIPVisible=!1},doPool(e){y(e.row.id).then((t=>{let i=[];t.data.forEach((e=>{i.push(e.id)}));let l=[];m().then((t=>{t.data.forEach((t=>{let a={label:t.ipaddr,key:t.id,spell:t.ipaddr,disabled:!1};l.push(a),this.currentJobId=e.row.id,this.allIPData=l,this.currentIPValue=i,this.transferChanged=!1,this.editIPDialog=e.row.name,this.editIPVisible=!0}))})).catch((e=>console.log(e)))})).catch((e=>console.log(e)))},updateJobIPList(){let e={job_id:this.currentJobId,machines_ids:[]};this.currentIPValue.forEach((t=>{t&&e.machines_ids.push(t)})),b(e).then((e=>{this.$notify({title:"成功",message:"整理成功！",type:"success"}),this.doGetJobs()})).catch((e=>console.log(e)))},transferChange(e,t,i){this.transferChanged=!0},invocate(e){const t=!this.jobs[e.$index].enabled,i={id:e.row.id,enabled:t};g(i).then((i=>{this.$notify({title:"成功",message:"更新状态成功！",type:"success"}),this.jobs[e.$index].enabled=t,this.jobs=[...this.jobs]})).catch((e=>console.log(e)))}}},T=j();w("data-v-685d4c14");const D={class:"jobs-board"},E={class:"do_action"},L={style:{"padding-right":"15px"}},G=x("让Prometheus服务重新加载配置"),O=x("发布"),M=x("发布"),A=x("添加组"),U={class:"change_order_button"},N={class:"actioneara"},q=x("编辑"),F=x("禁用"),R=x("启用"),Y=x("IP池"),B=J("p",null,"确定删除吗？",-1),K={style:{"text-align":"right",margin:"0"}},H=x("取消"),Q=x("确定"),W=x("删除"),X={key:0,class:"block"},Z=x("取消"),ee={class:"ip-list-push-box"},te=x("关闭"),ie=x("提交");_();const le=T(((e,t,i,l,a,o)=>{const s=C("el-button"),n=C("el-input"),d=C("el-descriptions-item"),r=C("el-descriptions"),p=C("el-table-column"),h=C("el-popover"),c=C("el-table"),u=C("el-pagination"),b=C("el-form-item"),g=C("el-option"),m=C("el-select"),f=C("el-form"),y=C("el-dialog"),w=C("el-transfer"),_=C("el-row");return I(),P("div",D,[J("div",E,[J("div",L,[J(s,{size:"small",type:"warning",onClick:t[1]||(t[1]=e=>o.restartServer())},{default:T((()=>[G])),_:1}),!1===a.publishMode?(I(),P(s,{key:0,size:"small",icon:"el-icon-upload",type:"primary",onClick:t[2]||(t[2]=e=>o.publishJobsfunc())},{default:T((()=>[O])),_:1})):z("",!0),!0===a.publishMode?(I(),P(s,{key:1,icon:"el-icon-loading",size:"small",type:"primary",onClick:t[3]||(t[3]=e=>o.publishJobsRunning())},{default:T((()=>[M])),_:1})):z("",!0),J(s,{size:"small",type:"success",plain:"",onClick:t[4]||(t[4]=e=>o.doAdd())},{default:T((()=>[A])),_:1})]),J("div",null,[J("div",null,[J(n,{size:"small",placeholder:"请输入内容",onKeyup:t[6]||(t[6]=V((e=>o.onSearch()),["enter"])),modelValue:a.searchContent,"onUpdate:modelValue":t[7]||(t[7]=e=>a.searchContent=e)},{append:T((()=>[J(s,{size:"small",onClick:t[5]||(t[5]=e=>o.onSearch()),icon:"el-icon-search"})])),_:1},8,["modelValue"])])])]),J(c,{size:"mini","highlight-current-row":"",border:"",data:a.jobs,stripe:"","row-style":o.rowStyle,"cell-style":o.cellStyle,onExpandChange:o.expandChange},{default:T((()=>[J(p,{type:"expand"},{default:T((e=>[J(r,{title:"IP列表",size:"mini",column:4,border:""},{default:T((()=>[(I(!0),P(k,null,v(a.jobAllIPList[e.row.id],((e,t)=>(I(),P(d,{key:t,label:t+1},{default:T((()=>[x(S(e.ipaddr),1)])),_:2},1032,["label"])))),128))])),_:2},1024)])),_:1}),J(p,{label:"序号",width:"50px"},{default:T((e=>[x(S(e.$index+1),1)])),_:1}),J(p,{label:"JOB组名称",prop:"name","show-overflow-tooltip":""}),J(p,{label:"端口号",width:"100px",prop:"port"}),J(p,{label:"IP数",width:"75px"},{default:T((e=>[J(s,{size:"mini",type:"text",onClick:t=>o.doEditLabelsJob(e)},{default:T((()=>[x(S(e.row.ip_count),1)])),_:2},1032,["onClick"])])),_:1}),J(p,{label:"子组数",width:"90px"},{default:T((e=>[J(s,{size:"mini",type:"text",onClick:t=>o.doEditLabelsJob(e)},{default:T((()=>[x(S(e.row.group_count),1)])),_:2},1032,["onClick"])])),_:1}),J(p,{label:"重写标签",prop:"relabel_name","show-overflow-tooltip":""}),J(p,{label:"排序",width:"75px",prop:"display_order"}),J(p,{label:"调整排序",width:"70px"},{default:T((e=>[J("div",U,[J(s,{size:"mini",type:"primary",icon:"el-icon-top",onClick:t=>o.doUp(e),plain:""},null,8,["onClick"]),J(s,{size:"mini",type:"primary",icon:"el-icon-bottom",onClick:t=>o.doDown(e),plain:""},null,8,["onClick"])])])),_:1}),J(p,{label:"最后更新时间",prop:"update_at",width:"180px"},{default:T((({row:e})=>[J("span",null,S(o.parseTimeSelf(e.update_at)),1)])),_:1}),J(p,{label:"操作",align:"center",width:"235px"},{default:T((e=>[J("div",N,[J("div",null,[J(s,{size:"mini",type:"primary",onClick:t=>o.doEdit(e),plain:""},{default:T((()=>[q])),_:2},1032,["onClick"])]),J("div",null,[!0===e.row.enabled?(I(),P(s,{key:0,size:"mini",type:"info",onClick:t=>o.invocate(e),plain:""},{default:T((()=>[F])),_:2},1032,["onClick"])):z("",!0),!1===e.row.enabled?(I(),P(s,{key:1,size:"mini",type:"warning",onClick:t=>o.invocate(e),plain:""},{default:T((()=>[R])),_:2},1032,["onClick"])):z("",!0)]),J("div",null,[J(s,{size:"mini",type:"primary",onClick:t=>o.doPool(e),plain:""},{default:T((()=>[Y])),_:2},1032,["onClick"])]),J("div",null,[J(h,{visible:a.deleteVisible[e.$index],placement:"top"},{reference:T((()=>[J(s,{size:"mini",type:"danger",plain:"",onClick:t=>o.doDelete(e)},{default:T((()=>[W])),_:2},1032,["onClick"])])),default:T((()=>[B,J("div",K,[J(s,{size:"mini",type:"text",onClick:t=>o.doNo(e)},{default:T((()=>[H])),_:2},1032,["onClick"]),J(s,{type:"primary",size:"mini",onClick:t=>o.doYes(e)},{default:T((()=>[Q])),_:2},1032,["onClick"])])])),_:2},1032,["visible"])])])])),_:1})])),_:1},8,["data","row-style","cell-style","onExpandChange"]),a.pageshow?(I(),P("div",X,[J(u,{onSizeChange:o.handleSizeChange,onCurrentChange:o.handleCurrentChange,"current-page":a.currentPage,"page-sizes":[10,15,30,50],"page-size":a.pageSize,layout:"total, sizes, prev, pager, next, jumper",total:a.pageTotal},null,8,["onSizeChange","onCurrentChange","current-page","page-size","total"])])):z("",!0),J(y,{title:a.dialogTitle,modelValue:a.dialogVisible,"onUpdate:modelValue":t[13]||(t[13]=e=>a.dialogVisible=e),width:"400px",modal:"","before-close":o.handleClose},{default:T((()=>[J("span",null,[J(f,{"label-position":"right",rules:a.rules,ref:"addJobInfo",model:a.addJobInfo,"label-width":"90px",size:"small"},{default:T((()=>[J(b,{label:"分组名：",prop:"name"},{default:T((()=>[J(n,{style:{width:"230px"},modelValue:a.addJobInfo.name,"onUpdate:modelValue":t[8]||(t[8]=e=>a.addJobInfo.name=e)},null,8,["modelValue"])])),_:1}),J(b,{label:"端口号",prop:"port"},{default:T((()=>[J(n,{type:"number",style:{width:"230px"},modelValue:a.addJobInfo.port,"onUpdate:modelValue":t[9]||(t[9]=e=>a.addJobInfo.port=e),modelModifiers:{number:!0}},null,8,["modelValue"])])),_:1}),J(b,{label:"重写标签",prop:"relabel_id"},{default:T((()=>[J(m,{modelValue:a.addJobInfo.relabel_id,"onUpdate:modelValue":t[10]||(t[10]=e=>a.addJobInfo.relabel_id=e),filterable:"","allow-create":"","default-first-option":"",placeholder:"请选择",style:{width:"230px"}},{default:T((()=>[(I(!0),P(k,null,v(a.relabelList,(e=>(I(),P(g,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),J(b,{size:"small"},{default:T((()=>[J(s,{size:"small",type:"primary",onClick:t[11]||(t[11]=e=>o.onSubmit("addJobInfo"))},{default:T((()=>[x(S(a.buttonTitle),1)])),_:1}),J(s,{size:"small",type:"info",onClick:t[12]||(t[12]=e=>o.onCancel("addJobInfo"))},{default:T((()=>[Z])),_:1})])),_:1})])),_:1},8,["rules","model"])])])),_:1},8,["title","modelValue","before-close"]),J(y,{title:"IP池 - "+a.editIPDialog,modelValue:a.editIPVisible,"onUpdate:modelValue":t[15]||(t[15]=e=>a.editIPVisible=e),width:"700px",modal:"","before-close":o.clearIPClose},{default:T((()=>[J(_,{type:"flex",align:"middle",justify:"center"},{default:T((()=>[J(w,{modelValue:a.currentIPValue,"onUpdate:modelValue":t[14]||(t[14]=e=>a.currentIPValue=e),filterable:"","filter-method":o.filterIPMethod,"filter-placeholder":"请输入关键字",data:a.allIPData,onChange:o.transferChange,titles:["IP池","Job组IP列表"]},null,8,["modelValue","filter-method","data","onChange"])])),_:1}),J("div",ee,[J(s,{class:"ip-list-close-btn",type:"info",size:"small",onClick:o.clearIPClose},{default:T((()=>[te])),_:1},8,["onClick"]),J(s,{class:"ip-list-push-btn",type:"warning",size:"small",onClick:o.updateJobIPList},{default:T((()=>[ie])),_:1},8,["onClick"])])])),_:1},8,["title","modelValue","before-close"])])}));$.render=le,$.__scopeId="data-v-685d4c14";export default $;
