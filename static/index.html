<!DOCTYPE html>
<html lang="zh-CN">
 <head> 
  <meta charset="utf-8" /> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1" /> 
  <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ --> 
  <title>IP管理</title> 
  <!-- Bootstrap --> 
  <link href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" /> 
  <style type="text/css">
  	.modal-body div{
  		margin-bottom: 10px;
  		vertical-align: middle;
  	}
  	.modal-body div .log_title{
  		min-width: 40px;
    	display: inline-block;
    	text-align: right;
    	margin-right: 10px;
  	}
  	.modal-body div #ip{
  		width: 200px;
  		border-radius: 5px;
  		padding: 2px 6px;
  	}
  	.modal-body .group input{
  		cursor: pointer;
  	}
  </style> 
  <style>
	
	</style> 
 </head> 
 <body> 
  <div class="container"> 
   <div style="text-align:center"> 
    <h2>IP管理</h2> 
   </div> 
   <div class="panel panel-primary"> 
    <div class="panel-heading"> 
     <h3 class="panel-title">IP列表</h3> 
    </div> 
    <div class="panel-body"> 
     <form class="form-inline"> 
      <div class="row"> 
       <div class="col-sm-3" style="float: left;"> 
        <button type="button" class="btn btn-primary" onclick="add()">新增</button> 
        <button type="button" class="btn btn-primary" onclick="pushDo()">发布</button> 
       </div>
	   <div class="col-sm-3" style="float: right;">
		<div class="input-group" style="width: 250px;">
			<input type="text" id="searchContext" class="form-control" placeholder="搜索...">
			<span class="input-group-btn">
			  <button class="btn btn-default" id="doEachAction" type="button" onclick="do_earch()">搜索</button>
			</span>
		  </div><!-- /input-group -->
	   </div>
      </div>
     </form> 
     <table class="table table-hover" style="margin-top:2px;"> 
      <thead> 
       <tr> 
        <th>序号</th> 
        <th>IP</th> 
        <th>分组</th> 
        <th>操作</th> 
       </tr> 
      </thead> 
      <tbody> 
      </tbody> 
     </table> 
    </div> 
   </div> 
   <div style="margin:0px;text-align:center;margin-top:0px;"> 
    <ul class="pagination" style="height:100px;"> 
    </ul> 
   </div> 
  </div> 
  <!-- jQuery文件。务必在bootstrap.min.js 之前引入 --> 
  <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script> 
  <!-- 最新的 Bootstrap 核心 JavaScript 文件 --> 
  <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script> 
  <!-- 模态框（Modal） --> 
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> 
   <div class="modal-dialog"> 
    <div class="modal-content"> 
     <div class="modal-header"> 
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true"> &times; </button> 
      <h4 class="modal-title" id="myModalLabel"> IP记录 </h4> 
     </div> 
     <div class="modal-body"> 
      <div> 
       <span class="log_title">IP:</span> 
       <input value="" id="ip" /> 
      </div> 
      <div> 
       <span class="log_title">分组:</span> 
       <span class="group"> </span> 
      </div> 
      <input type="hidden" id="id" value="" /> 
     </div> 
     <div class="modal-footer"> 
      <button type="button" class="btn btn-default" data-dismiss="modal">关闭 </button> 
      <button type="button" class="btn btn-primary" onclick="addIp()"> 提交 </button> 
     </div> 
    </div>
    <!-- /.modal-content --> 
   </div>
   <!-- /.modal --> 
  </div> 
  <div class="modal fade" id="myInfo"> 
   <div class="modal-dialog"> 
    <div class="modal-content"> 
     <div class="modal-header"> 
      <h3>操作提示</h3> 
     </div> 
     <div class="modal-body"> 
      <p class="infoChange">提示信息</p> 
     </div> 
     <div class="modal-footer"> 
      <button class="btn btn-info" data-dismiss="modal">关闭</button> 
     </div> 
    </div> 
   </div> 
  </div> 
  <script type="text/javascript">
	    $("#searchContext").keydown(function() {
			if (event.keyCode == "13") {
				$('#doEachAction').click();
			}
		});
		// var url = window.location.host;
		//var url = 'http://27.151.29.204:8200';
		var page = 1;
		var limit = 15;
		var left = 0;
		var right = 0;
		function addIp(){
			let ip = $('#ip').val();
			let id = $('#id').val();
			let arr = [];
			let state = '';
			let submitType = '';
			let data = '';
		    $('input[name="checkbox"]').each(function(){
		        state = $(this).prop('checked');
		        if(state){
		          	arr.push(parseInt($(this).val()));
		        }
		    })
		    if(arr.length == 0){
		    	infoView('分组信息至少选一个');
		    	return false;
		    }
		    if(/^((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])$/.test(ip) == false ){
		    	infoView('IP地址格式有误');
		    	return false;
		    }
		    if(id){
		    	submitType = 'put';
		    	data = {'id':parseInt(id),'ipaddr':ip,'job_id':arr};
		    }else{
		    	submitType = 'post';
		    	data = {'ipaddr':ip,'job_id':arr};
		    }
			
			$.ajax({
                url : '/v1/machine',
                type : submitType,
                data: JSON.stringify(data),
                datatype: 'json',
                success: function(res){
                	if(res.code == 200000){
                		if(id){
                			infoView(res.msg);
                			get_list();
                			$('#myModal').modal('hide');
                		}else{
                			infoView(res.msg);
                      setTimeout("location.reload()", 2000);
                		}
                	}else{
                		infoView(res.msg);
                	}
                },
                error: function(err){

                }
            })
		}

		function infoView(msg){
			$('.infoChange').text(msg);
			$('#myInfo').modal('show');
		}

		function add(){
			$('#ip').val('');
			$('#id').val('');
			update_group();
			show_modal();
		}

		function do_earch(){
			get_list();
		}

		function show_modal() {
	        $('#myModal').modal('show');
	    }

		$(document).ready(function(){
			//获取数据
			get_group();
			get_list();
		})

		function get_group(){
			if(localStorage.getItem('jobList')){
				return false;
			}
			$.ajax({
                url : '/v1/jobs',
                type : 'get',
                datatype: 'json',
                success: function(res){
                	if(res.code == 200000){
                		localStorage.setItem('jobList',JSON.stringify(res.data));
                		let str = '';
                		$('.group').children().remove();
                		$.each(res.data, function(i,result){
                			str += "<span><input value='"+result.id+"' type='checkbox' name='checkbox'>"+result.name+"&nbsp;&nbsp;&nbsp;</span>";
                		})
                		$('.group').append(str);
                	}
                },
                error: function(err){

                }
            })
		}

		function update_group(){
			let str = '';
    		$('.group').children().remove();
    		jobList = JSON.parse(localStorage.getItem('jobList'));
    		$.each(jobList, function(i,result){
    			str += "<span><input value='"+result.id+"' type='checkbox' name='checkbox'>"+result.name+"&nbsp;&nbsp;&nbsp;</span>";
    		})
    		$('.group').append(str);
		}

		function get_list(){
			left = 0;
			right = 0;
			search = $('#searchContext').val();
			$.ajax({
                url : '/v1/machines?pageNo='+page+'&pageSize='+limit+'&search='+search,
                type : 'get',
                datatype: 'json',
                success: function(res){
                	if(res.code == 200000){
                		$('tbody').children().remove();
                		let list = res.data.data;
                		let str = '';
                		if(list.length > 0){
                			let j = 0;
                			jobList = JSON.parse(localStorage.getItem('jobList'));
                			let arrStr = '';
                			let arrJson = '';
                			$.each(list, function(i,result){
                				if(result.job_id.length > 0){
                					arrStr = '';
                					arrJson = '';
                					$.each(result.job_id,function(j,resu){
                						$.each(jobList,function(k,resJob){
                							if(resu == resJob.id){
                								if(arrStr == ''){
                									arrStr += resJob.name;
                								}else{
                									arrStr += ',' + resJob.name;
                								}
                							}
                						})
                						arrJson += resu.toString();
                					})
                				}
                				j = i + 1;
                				str += "<tr><th scope='row'>"+j+"</th><td>"+result.ipaddr+"</td><td>"+arrStr+"</td><td><a href='javascript:void(0)' onclick=\"edit("+result.id+",\'"+result.ipaddr+"\',"+arrJson+")\">编辑</a>&nbsp;<a href='javascript:void(0)' onclick=\"deleteDo("+result.id+")\">删除</a></td></tr>";
                			})
                		}else{
                			str += "<tr><td colspan='4'>暂无记录</td><tr>";
                		}
                		$('tbody').append(str);
                		$('.pagination').children().remove();
                		//分页
                		if(res.data.totalPage > 0){
                			let str = '';
                			let i = 1;
                			//左箭头
                			if(res.data.pageNo == 1){
                				str += "<li class='disabled'><a href='javascript:void(0)'>&laquo;</a></li>";
                			}else{
                				let last = parseInt(res.data.pageNo) - 1;
                				str += "<li><a href='javascript:void(0)' onclick='goto("+last+")'>&laquo;</a></li>";
                			}

                			for (i; i <= parseInt(res.data.totalPage); i++) {
                				if(i == res.data.pageNo){
                					str += "<li class='active'><a href='javascript:void(0)'>"+res.data.pageNo+"</a></li>";
                				}else{
                					if(res.data.totalPage > 11){
                						//分页数据超过11，额外的加小数点
                						if(i == 1 || i == 2 || i == res.data.totalPage - 1 || i == res.data.totalPage){
                							str += "<li><a href='javascript:void(0)' onclick='goto("+i+")'>"+i+"</a></li>";
                						}else{
                							if(res.data.pageNo - i > 3){
                								left ++;
                								if(left == 1){
                									str += "<li class='active'><a href='javascript:void(0)'>...</a></li>"
                								}
                							}else{
                								if(i - res.data.pageNo > 3){
                									right ++;
	                								if(right == 1){
	                									str += "<li class='active'><a href='javascript:void(0)'>...</a></li>"
	                								}
                								}else{
                									str += "<li><a href='javascript:void(0)' onclick='goto("+i+")'>"+i+"</a></li>";
                								}
                							}
                						}
                					}else{
                						str += "<li><a href='javascript:void(0)' onclick='goto("+i+")'>"+i+"</a></li>";
                					}
                				}
                				
                			}

                			//又箭头
                			if(res.data.pageNo == res.data.totalPage){
                				str += "<li class='disabled'><a href='javascript:void(0)'>&raquo;</a></li>";
                			}else{
                				let last = parseInt(res.data.pageNo) - 1;
                				str += "<li><a href='javascript:void(0)' onclick='goto("+last+")'>&raquo;</a></li>";
                			}

                			str += "<li>&nbsp;&nbsp; 总记录 "+res.data.totalCount+" 总页数 "+res.data.totalPage+" 当前第 "+res.data.pageNo+" 页 转到 <input type='text' style='width:30px;' class='input' value='1' /> 页 <button type='button' class='btn btn-success' onclick='goto2(this)'>确定</button> </li>";
                			$('.pagination').append(str);
                		}
                	}
                },
                error: function(err){

                }
            })
		}
		function goto(num){
			page = num;
			get_list();
		}
		function goto2(that) {
			page = $(that).siblings('.input').val();
			get_list();
		}

		function pushDo(){
			$.ajax({
				url : '/v1/publish',
				type : 'post',
				datatype: 'json',
				success: function(res){
					if(res.code == 200000){
						infoView(res.msg);
						get_list();
					}else{
						infoView(res.msg);
					}
				},
				error: function(err){

				}
			})
		}

		function edit(id,ip,group){
			update_group();
			$('#ip').val(ip);
			$('#id').val(id);
			jobList = JSON.parse(localStorage.getItem('jobList'));
			$.each(jobList, function(i, result){
				if(group.toString().indexOf(result.id) != -1){
					$('input[name="checkbox"]:eq('+i+')').attr('checked','checked');
				}
			})
			show_modal();
		}

		function deleteDo(id){
			$.ajax({
                url : '/v1/machine?id='+id,
                type : 'delete',
                datatype: 'json',
                success: function(res){
                	if(res.code == 200000){
                		infoView(res.msg);
                		get_list();
                	}else{
                		infoView(res.msg);
                	}
                },
                error: function(err){

                }
            })
		}
	</script>  
 </body>
</html>